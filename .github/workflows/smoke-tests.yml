# Copyright 2025 The Authors (see AUTHORS file)
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: 'smoke-tests'

on:
  workflow_call:
    inputs:
      runs-on:
        description: 'The runner environment to use for jobs.'
        type: 'string'
      runner_contexts:
        description: 'The matrix of runner contexts.'
        required: true
        type: 'string'

env:
  DOCKER_REGISTRY: 'us-central1-docker.pkg.dev'
  DOCKER_REPO: 'us-central1-docker.pkg.dev/github-action-runner-i-02/ci-images'
  IMAGE_NAME: 'github-action-runner'
  IMAGE_TAG: 'ci-${{ github.run_id }}-${{ github.run_number }}'

  DISPATCHER_DOCKER_REPO: 'us-docker.pkg.dev/abcxyz-artifacts/docker-images'
  DISPATCHER_IMAGE_NAME: 'github-action-dispatcher'
  DISPATCHER_VERSION: 'v0.0.0'

  INTEGRATION_RUNNER_LABEL: 'github-action-runner-integration'
  INTEGRATION_RUNNER_LOCATION: 'us-central1'
  INTEGRATION_RUNNER_PROJECT_ID: 'abcxyz-gar-runner-i-4f'
  INTEGRATION_RUNNER_SERVICE_ACCOUNT: 'projects/abcxyz-gar-runner-i-4f/serviceAccounts/abcxyz-gar-runner-sa@abcxyz-gar-runner-i-4f.iam.gserviceaccount.com'

  INTEGRATION_PROJECT_ID: 'github-action-runner-i-02'
  INTEGRATION_REGION: 'us-central1'
  INTEGRATION_SERVICE_ACCOUNT: 'gad-webhook-sa@github-action-runner-i-02.iam.gserviceaccount.com'
  INTEGRATION_SERVICE_NAME: 'github-action-dispatcher-23db'
  INTEGRATION_WIF_PROVIDER: 'projects/712187603283/locations/global/workloadIdentityPools/github-automation/providers/gar-ci-i'
  INTEGRATION_WIF_SERVICE_ACCOUNT: 'github-automation-bot@gha-gar-ci-i-be70aa.iam.gserviceaccount.com'

jobs:
  deploy-dispatcher:
    runs-on: 'ubuntu-latest'
    permissions:
      contents: 'read'
      id-token: 'write'
    strategy:
      fail-fast: false
      matrix:
        include: '${{ fromJson(inputs.runner_contexts) }}'
      max-parallel: 1
    env:
      GITHUB_APP_ID: '2274453'
      KMS_APP_PRIVATE_KEY_ID: 'projects/github-action-runner-i-02/locations/us-central1/keyRings/gad-ea-key-ring/cryptoKeys/gad-ea-pk/cryptoKeyVersions/1'
    steps:
      - name: 'Checkout'
        uses: 'actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683' # ratchet:actions/checkout@v4

      - id: 'auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@a6e2e39c0a0331da29f7fd2c2a20a427e8d3ad1f' # ratchet:google-github-actions/auth@v2
        with:
          workload_identity_provider: '${{ env.INTEGRATION_WIF_PROVIDER }}'
          service_account: '${{ env.INTEGRATION_WIF_SERVICE_ACCOUNT }}'
          token_format: 'access_token'

      - name: 'Setup gcloud'
        uses: 'google-github-actions/setup-gcloud@6189d56e4096ee891640bb02ac264be376592d6a' # ratchet:google-github-actions/setup-gcloud@v2
        with:
          version: '529.0.0'

      - name: 'Deploy to Cloud Run'
        id: 'deploy'
        run: |-
          WEBHOOK_SECRET_MOUNT_PATH="/etc/secrets/webhook/key"
          WEBHOOK_SECRET_NAME="webhook-key"
          WEBHOOK_SECRET_VERSION="latest"

          cat > /tmp/env_vars <<EOF
          GITHUB_APP_ID: '${{ env.GITHUB_APP_ID }}'
          KMS_APP_PRIVATE_KEY_ID: '${{ env.KMS_APP_PRIVATE_KEY_ID }}'
          RUNNER_IMAGE_NAME: '${{ env.IMAGE_NAME }}'
          RUNNER_IMAGE_TAG: '${{ env.IMAGE_TAG }}-${{ matrix.context }}-${{ matrix.arch }}'
          RUNNER_LABEL: '${{ env.INTEGRATION_RUNNER_LABEL }}'
          RUNNER_LOCATION: '${{ env.INTEGRATION_RUNNER_LOCATION }}'
          RUNNER_PROJECT_ID: '${{ env.INTEGRATION_RUNNER_PROJECT_ID }}'
          RUNNER_REPOSITORY_ID: '${{ env.DOCKER_REPO }}'
          RUNNER_SERVICE_ACCOUNT: '${{ env.INTEGRATION_RUNNER_SERVICE_ACCOUNT }}'
          WEBHOOK_KEY_MOUNT_PATH: '${WEBHOOK_SECRET_MOUNT_PATH}'
          WEBHOOK_KEY_NAME: '${WEBHOOK_SECRET_NAME}'
          EOF

          gcloud run deploy "${{ env.INTEGRATION_SERVICE_NAME }}" \
            --project="${{ env.INTEGRATION_PROJECT_ID }}" \
            --region="${{ env.INTEGRATION_REGION }}" \
            --service-account="${{ env.INTEGRATION_SERVICE_ACCOUNT }}" \
            --image="${{ env.DISPATCHER_DOCKER_REPO }}/${{ env.DISPATCHER_IMAGE_NAME }}:${{ env.DISPATCHER_VERSION }}-${{ matrix.arch }}" \
            --ingress=internal-and-cloud-load-balancing \
            --no-allow-unauthenticated \
            --set-secrets="${WEBHOOK_SECRET_MOUNT_PATH}/${WEBHOOK_SECRET_NAME}=${WEBHOOK_SECRET_NAME}:${WEBHOOK_SECRET_VERSION}" \
            --env-vars-file=/tmp/env_vars

  test-github-script-action:
    runs-on: '${{ inputs.runs-on }}'
    needs: ['deploy-dispatcher']
    steps:
      - name: 'Hello world script'
        uses: 'actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea' # ratchet:actions/github-script@v7
        with:
          script: |-
            core.info("Hello World");

  test-js-action:
    runs-on: '${{ inputs.runs-on }}'
    needs: ['deploy-dispatcher']
    steps:
      - name: 'Run action'
        uses: 'actions/hello-world-javascript-action@ad41a6c27317e688719c813b0d6a25685a9bce54' # ratchet:actions/hello-world-javascript-action@v1.1
        with:
          who-to-greet: 'self hosted runner users'

  # This test is to check Docker-in-Docker volume mounting. It's possible that the docker run command will succeed but not properly mount the files and workflows subsequently fail.
  check-docker-volume-mount:
    runs-on: '${{ inputs.runs-on }}'
    needs: ['deploy-dispatcher']
    steps:
      - name: 'Checkout Repository'
        uses: 'actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683' # ratchet:actions/checkout@v4

      - name: 'Test GITHUB_WORKSPACE mount inside Docker'

        id: 'mount-check'
        shell: 'bash'
        run: |
          echo "Host GITHUB_WORKSPACE is: $GITHUB_WORKSPACE"
          echo "Contents of GITHUB_WORKSPACE on host:"
          ls -laR "$GITHUB_WORKSPACE"


          echo "Running Docker container to check mounted workspace..."
          docker run --rm \
            -v "$GITHUB_WORKSPACE:/github/workspace" \
            -w "/github/workspace" \
            alpine sh -c "ls -laR" > docker_ls_output.txt

          echo "--- Output from inside container (docker_ls_output.txt) ---"
          cat docker_ls_output.txt
          echo "---------------------------------------------------------"

          if grep -q "runner" docker_ls_output.txt; then
            echo "::notice file=check-docker-volume-mount.yml::Docker volume mount appears to be working correctly."
            echo "status=PASSED" >> "$GITHUB_OUTPUT"
          else
            echo "::error file=check-docker-volume-mount.yml::Docker volume mount failed or is empty."
            echo "status=FAILED" >> "$GITHUB_OUTPUT"
            exit 1 # Fail the step if the mount is empty
          fi

  test-go-version:
    runs-on: '${{ inputs.runs-on }}'
    needs: ['deploy-dispatcher']
    steps:
      - name: 'Setup Go'
        uses: 'actions/setup-go@0aaccfd150d50ccaeb58ebd88d36e91967a5f35b' # ratchet:actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: 'Check Go version'
        run: |
          echo "Checking Go version on self-hosted runner..."
          go version

  # TODO: Figure out why the target repos are failing to lint these unrelated abcxyz repos, they were passing previously.

  # run-lint-tests-pkg:
  #   uses: './.github/workflows/smoke-test-lint.yml'
  #   with:
  #     repo-to-lint: 'abcxyz/pkg'
  #     ref: 'main'
  #     runs-on: '${{ inputs.runs-on }}'

  # run-lint-tests-java-repo:
  #   uses: './.github/workflows/smoke-test-lint.yml'
  #   with:
  #     repo-to-lint: 'abcxyz/lumberjack'
  #     ref: 'main'
  #     runs-on: '${{ inputs.runs-on }}'

  test-buildx-buildkit-functionality:
    needs: ['deploy-dispatcher']
    uses: './.github/workflows/smoke-test-buildx-buildkit.yml'
    with:
      runs-on: '${{ inputs.runs-on }}'

  test-create-pull-request-minty:
    if: |-
      ${{ github.ref == 'refs/heads/main' }}
    needs: ['deploy-dispatcher']
    uses: './.github/workflows/smoke-test-minty.yml'
    permissions:
      contents: 'read'
      id-token: 'write'
    with:
      runs-on: '${{ inputs.runs-on }}'

  test-github-functionality:
    needs: ['deploy-dispatcher']
    uses: './.github/workflows/smoke-test-gh.yaml'
    with:
      runs-on: '${{ inputs.runs-on }}'

  test-gcp-functionality:
    needs: ['deploy-dispatcher']
    uses: './.github/workflows/smoke-test-gcp.yml'
    permissions:
      id-token: 'write'
    with:
      runs-on: '${{ inputs.runs-on }}'

  test-setup-actions:
    needs: ['deploy-dispatcher']
    uses: './.github/workflows/smoke-test-setup.yml'
    with:
      runs-on: '${{ inputs.runs-on }}'

  test-setup-binary:
    runs-on: '${{ inputs.runs-on }}'
    needs: ['deploy-dispatcher']
    steps:
      - name: 'Setup abc'
        uses: 'abcxyz/actions/.github/actions/setup-binary@f26869a425d0b0217b9c8ad7e3f6ab70547272c9' # ratchet:main
        with:
          download_url: 'https://github.com/abcxyz/abc/releases/download/v0.10.1/abc_0.10.1_linux_amd64.tar.gz'
          install_path: '${{ runner.temp }}/.abc'
          binary_subpath: 'abc'
          cache_key: '${{ runner.os }}_${{ runner.arch }}_abc_0.10.1'
          add_to_path: true
      - name: 'Use abc'
        run: 'abc templates describe github.com/abcxyz/abc/t/rest_server@v0.10.0'

  test-build-push-runner:
    runs-on: '${{ inputs.runs-on }}'
    needs: ['deploy-dispatcher']
    env:
      WIF_PROVIDER: 'projects/712187603283/locations/global/workloadIdentityPools/github-automation/providers/gar-ci-i'
      WIF_SERVICE_ACCOUNT: 'github-automation-bot@gha-gar-ci-i-be70aa.iam.gserviceaccount.com'
      DOCKER_REPO: 'us-central1-docker.pkg.dev/github-action-runner-i-02/ci-images'
      DOCKER_REGISTRY: 'us-central1-docker.pkg.dev'
      GAR_IMAGE_NAME: 'github-action-runner-smoke-test'
      GAR_IMAGE_TAG: 'smoke-test-${{ github.run_id }}'
    steps:
      - name: 'Create Minimal Docker Context'
        id: 'create-context'
        shell: 'bash'
        run: |
          BUILD_CONTEXT="/tmp/minimal-build-context"

          # Create a minimal directory for the build context
          mkdir -p "${BUILD_CONTEXT}"

          # Create the simplest possible Dockerfile: just pull an image.
          echo "FROM alpine:latest" > "${BUILD_CONTEXT}/Dockerfile"
          echo "Minimal Dockerfile created at ${BUILD_CONTEXT}/Dockerfile"

          # Output the context path for the next step
          echo "build_context=${BUILD_CONTEXT}" >> "$GITHUB_OUTPUT"

      - id: 'auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@c200f3691d83b41bf9bbd8638997a462592937ed' # ratchet:google-github-actions/auth@v2
        with:
          workload_identity_provider: '${{ env.WIF_PROVIDER }}'
          service_account: '${{ env.WIF_SERVICE_ACCOUNT }}'
          token_format: 'access_token'

      - name: 'Setup gcloud'
        uses: 'google-github-actions/setup-gcloud@e427ad8a34f8676edf47cf7d7925499adf3eb74f' # ratchet:google-github-actions/setup-gcloud@v2
        with:
          version: '529.0.0'

      - uses: 'docker/login-action@465a07811f14bebb1938fbed4728c6a1ff8901fc' # ratchet:docker/login-action@v2
        with:
          username: 'oauth2accesstoken'
          password: '${{ steps.auth.outputs.access_token }}'
          registry: '${{ env.DOCKER_REGISTRY }}'

      - name: 'Build Docker image'
        id: 'push'
        uses: 'docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83' # ratchet:docker/build-push-action@@v6.5.0
        with:
          context: '${{ steps.create-context.outputs.build_context }}'
          file: '${{ steps.create-context.outputs.build_context }}/Dockerfile'
          push: true
          tags: '${{ env.DOCKER_REPO }}/${{ env.GAR_IMAGE_NAME }}:${{ env.GAR_IMAGE_TAG }}'

  maybe-create-smoke-test-image:
    needs: ['deploy-dispatcher']
    uses: 'abcxyz/actions/.github/workflows/maybe-build-docker.yml@f26869a425d0b0217b9c8ad7e3f6ab70547272c9' # ratchet:main
    permissions:
      contents: 'read'
      packages: 'write'
    with:
      runs_on: '"${{ inputs.runs-on }}"'
      dockerfile: '.github/workflows/smoke-test-container-test.dockerfile'
      github_image_name: 'ghcr.io/${{ github.repository }}/smoke-test-container-test'

  # Note, normally this job fails in the initialize containers step with the
  # following error message:
  #
  # "Error: Container feature is not supported when runner is already running inside container."
  # https://github.com/actions/runner/blob/463496e4fb25773f9409c94ba8209f061a0aa612/src/Runner.Worker/ContainerOperationProvider.cs#L539-L557
  #
  # We implement a hacky workaround for this that makes this pass.
  test-container-feature:
    runs-on: '${{ inputs.runs-on }}'
    needs: ['maybe-create-smoke-test-image']
    permissions:
      contents: 'read'
      packages: 'read'
    container:
      image: 'ghcr.io/${{ github.repository }}/smoke-test-container-test:${{ needs.maybe-create-smoke-test-image.outputs.docker_tag }}'
      credentials:
        username: '${{ github.actor }}'
        password: '${{ secrets.GITHUB_TOKEN }}'
    steps:
      - name: 'Checkout'
        uses: 'actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683' # ratchet:actions/checkout@v4

      - name: 'Test runs on custom container'
        shell: 'bash'
        run: |
          UNIQUE_FILE_IN_CONTAINER="/smoke-test-container-test/index.txt"
          if [ ! -f "${UNIQUE_FILE_IN_CONTAINER}" ]; then
            echo "File not found: ${UNIQUE_FILE_IN_CONTAINER}"
            exit 1
          else 
            echo "Found file: ${UNIQUE_FILE_IN_CONTAINER}"
          fi
