# Copyright 2025 The Authors (see AUTHORS file)
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: 'minty-tests'

on:
  workflow_call:
    inputs:
      runs-on:
        description: 'The runner environment to use.'
        required: false
        type: 'string'
        default: 'self-hosted'

concurrency:
  # Only allow one at a time as PR update is global.
  group: '${{ github.workflow }}'

jobs:
  write_pr:
    runs-on: '${{ inputs.runs-on }}'
    permissions:
      id-token: 'write'
      contents: 'read'
    env:
      REPOSITORY_NAME: 'github-action-runner'
      TEST_FILE: 'test-file.txt'
      HEAD_BRANCH: 'test/minty-create-pr'
    steps:
      - name: 'Checkout'
        uses: 'actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683' # ratchet:actions/checkout@v4
        with:
          ref: 'main'

      - name: 'Create unique file content'
        run: 'echo "hello $(date +%s)" > ${{ env.TEST_FILE }}'

      - name: 'Auth minty'
        id: 'minty-auth'
        uses: 'google-github-actions/auth@6fc4af4b145ae7821d527454aa9bd537d1f2dc5f' # ratchet:google-github-actions/auth@v2
        with:
          create_credentials_file: false
          export_environment_variables: false
          workload_identity_provider: '${{ vars.TOKEN_MINTER_WIF_PROVIDER }}'
          service_account: '${{ vars.TOKEN_MINTER_WIF_SERVICE_ACCOUNT }}'
          token_format: 'id_token'
          id_token_audience: '${{ vars.TOKEN_MINTER_SERVICE_AUDIENCE }}'
          id_token_include_email: true

      - id: 'mint-token'
        uses: 'abcxyz/github-token-minter/.github/actions/minty@main' # ratchet:exclude
        with:
          id_token: '${{ steps.minty-auth.outputs.id_token }}'
          service_url: '${{ vars.TOKEN_MINTER_SERVICE_URL }}'
          requested_permissions: |-
            {
              "scope": "make-pr",
              "repositories": ["${{ env.REPOSITORY_NAME }}"],
              "permissions": {
                "pull_requests": "write",
                "contents": "write"
              }
            }

      - name: 'Create/Update Pull Request'
        uses: 'abcxyz/actions/.github/actions/create-pull-request@main' # ratchet:exclude
        with:
          token: '${{ steps.mint-token.outputs.token }}'
          base_branch: '${{ github.event.repository.default_branch }}'
          head_branch: '${{ env.HEAD_BRANCH }}'
          title: '[automated][do not merge] Minty Test Pull Request'
          body: 'Ensuring a self-hosted runner is able to update a PR'
          changed_paths: '["${{ env.TEST_FILE }}"]'

      - name: 'Check Pull Request Updated'
        shell: 'bash'
        env:
          GH_TOKEN: '${{ github.token }}'
        run: |-
          gh pr -R abcxyz/${{ env.REPOSITORY_NAME }} list \
          --search "Minty Test Pull Request updated:>=$(date -u -Iseconds -d "1 minute ago")" \
          --limit 1 \
          --json id \
          | jq ".[0].id" -e
